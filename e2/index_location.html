<!-- Original script created by Tal Boger -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<div id="consent" style="	display:block; max-width: 80%;	margin: 0 auto;	margin-top: 0px; text-align: left;">
  <center><h1>Adult Consent Form</h1></center>
  <p>TITLE OF RESEARCH: Cognitive and Computational Mechanisms of Decision Making
  <p>PRINCIPAL INVESTIGATOR: Robb Rutledge, PhD
  <p>PRINCIPAL INVESTIGATOR'S DEPARTMENT: Psychology
  <p><b>Research Study Summary:</b>
  <li>We are asking you to join a research study.</li>
  <li>Study activities may include: behavioral tasks and self-report questionnaires.</li>
  <li>Your involvement will sometimes involve multiple sessions, with each session not expected to last longer than
  two hours, and with much shorter sessions being typical.</li>
  <li>There are no anticipated risks with this study, although you may experience boredom and fatigue.</li>
  <li>The study may have no benefits to you. However, the study will help us increase our understanding of decision
  making.</li>
  <li>Taking part in this study is your choice. You can choose to take part, or you can choose not to take part in this
  study. You also can change your mind at any time. Whatever choice you make will not have any effect on your
  relationship with Yale.</li>
  <li>If you are interested in learning more about the study, please continue reading, or have someone read to you,
  the rest of this document. Once you understand the study, we will ask you if you wish to participate.</li>
  <hr>
  <p>You are being invited to take part in a research study. Before you decide to participate in this study, it is important
  that you understand why the research is being done and what it will involve. Please take the time to read the
  following information carefully.
  <p><b>Purpose of the research:</b>
  <p>The purpose of this study is to advance our understanding of how humans make decisions.
  <p><b>Study Procedures:</b>
  <p>You may be asked to complete one or more tasks that focus on aspects of learning and decision making. We may
  ask you to complete a number of self-report questionnaires meant to gauge your emotions, personality, attitudes,
  behavior, and to record information about your recent experience. You will receive a minimum of $8 per hour for
  your participation, based on typical completion times and prorated for partial hours, including any bonuses due to
  task performance. If you decide to participate in this study, please understand that your participation is voluntary,
  and you have the right to withdraw your consent or discontinue participation at any time. The entire experiment will
  be conducted online on your own computerized device in a place of your choosing. The research will sometimes
  involve multiple sessions, with each session not expected to last longer than two hours, and with much shorter
  sessions being typical.
  <p><b>Benefits and Risks:</b>
  <p>It is important that you understand that there is no direct benefit to you anticipated from your participation in this
  study, however we hope that our results will help to increase our understanding of human decision making. It is
  possible but unlikely that this task may cause you discomfort or fatigue. To minimize risk, you will be given breaks
  and are free to withdraw at any time without any loss of payment. Although the study materials are selected to
  avoid highly emotional or evocative stimuli, there is a small risk that you may have an adverse reaction while
  completing aspects of the study. There is a slight chance you may feel frustrated or uncomfortable if a task is
  difficult, and you are free to discontinue your participation in the study if you choose without any loss of payment.
  <p><b>Alternatives:</b>
  The alternative to participating in this particular study is to not participate.
  <p><b>Confidentiality:</b>
  <p>All of your responses will be held in confidence. Only the researchers involved in this study and those responsible
  for research oversight (such as representatives of the Yale University Human Research Protection Program, the
  Yale University Institutional Review Boards, and others) will have access to any information that could identify
  you that you provide. We will share it with others if you agree to it or when we have to do it because U.S. or State
  law requires it. For example, we will tell somebody if we learn that you are hurting a child or an older person.
  <p>Completion of this study is anonymous. We will not know your name. We will not be able to connect any
  identifying information to your responses. However, your account is associated with an ID for the online testing
  platform (e.g., Prolific, Amazon Mechanical Turk) that the researcher may have to see in order to pay you and in
  order to link your data from multiple sessions. This ID could possibly be connected to your public profile, which
  could, in theory, be searched. We want to stress that we will not be looking at anyoneâ€™s public profiles. We will
  keep the information about your participation in this research confidential.
  <p><b>Who to contact with questions:</b>
  <p> 1. PRINCIPAL INVESTIGATOR: Robb Rutledge, PhD, Yale Department of Psychology, email: rutledge.lab@yale.edu
  <p> 2. If you have questions regarding your rights as a research subject, or if problems arise which you do not feel
  you can discuss with the Investigator, please contact the Institutional Review Board at:
  <p>Yale University Human Subjects Committee
  <p>Phone: (203) 785-4688
  <p>Email: hrpp@yale.edu
  <p><b>Agreement to Participate:</b>
  By clicking the "Accept" button below, you acknowledge that you have read and understood the above and
  voluntarily agree to participate in this study.

  <a href='javascript:acceptedConsent()' id='consentButton'>Accept</a>
  <br>
  <br>
</div>

<div id="experiment">
  <p id="title"><strong>Randomness game</strong></p>
  <p id="browserCompat"><strong>Unfortunately, this study does not work in your current browser. Please use Chrome, Firefox, or Safari. Sorry!</strong></p>
 	<span id="instructions">
    <p>In this task, you are going to <font color="teal"><b>generate random locations</b></font>.</p>
  </span>
  <span id="startInstructions">
    <p>On each 'trial', you'll see 9 black boxes forming a square grid. You'll want to click on one of the boxes randomly. When you click on a box, it will turn blue for a short time, after which time you can click another random box.</p>
    <p><font color="teal"><b>Your goal is to produce the most random sequence possible</b></font>, so try your best to act like a truly random machine. Don't overthink it; just try your best to be random.</p>
    <p>You'll do this about 250 times. That may sound like a lot, but each 'trial' only takes a second or two, so the time will go by quickly. <b>Please do make sure to pay attention and be as random as possible throughout the entire task</b>.</p>
    <p>After you do this task, you will be redirected to another, similar task. You will be instructed about that task before beginning it. <b>You must complete both tasks in order to complete the study and get it approved</b>.</p>
    <p>Press the button below to begin.</p>
    <br>
    <br>
    <a href='javascript:StartExperiment()' id='startExperiment'>Start experiment</a>
  </span>

  <div id="progressContainer">
    <div class="progress" id="progressText">Study Progress</div>
      <div class="progress" id="progressOutline">
      <div class="progress" id="progressBar"></div>
    </div>
  </div>
  <div id="trialInstructions">
    <p style="text-align:center">If all the boxes are black, click a random location.</p>
  </div>
  <br>
  <br>

</div>

<div class="likert" id="likertscale">
  <label><input name="l" type="radio" value="1"/><span></span></label>
  <label><input name="l" type="radio" value="2"/><span></span></label>
  <label><input name="l" type="radio" value="3"/><span></span></label>
  <label><input name="l" type="radio" value="4"/><span></span></label>
  <label><input name="l" type="radio" value="5"/><span></span></label>
  <label><input name="l" type="radio" value="6"/><span></span></label>
  <label><input name="l" type="radio" value="7"/><span></span></label>
  <label><input name="l" type="radio" value="8"/><span></span></label>
  <label><input name="l" type="radio" value="9"/><span></span></label>
</div>

<div id="questionText">
  <strong>Please answer the following questions.</strong>
  <p style="text-align:center">Please describe the task you had to complete in this study</p>
  <textarea id="taskGuess" rows=4 cols=40 placeholder="Enter your amswer here..."></textarea>
	<input type="hidden" id="taskGuess" name="taskGuess">
  <br>
  <p style="text-align:center">If you had to guess, what do you think was the purpose of this study?</p>
  <textarea id="purposeGuess" rows=4 cols=40 placeholder="Enter your answer here..."></textarea>
	<input type="hidden" id="purposeGuess" name="purposeGuess">
  <br>
  <p style="text-align:center">What is 1 + 1?</p>
  <textarea id="sumCheck" rows=1 cols=20 placeholder="Enter your answer here..."></textarea>
  <br>
  <br>
  <a href='javascript:doneExperiment()' id='doneExperiment' class='button'>Next</a>
</div>

<div id="doneText">
	<strong>This is the last page of the <b>first part</b> of the study. Do not close your browser! You will be able to submit your results and be redirected to the <b>second part</b> of the study at the end of this page. Recall that you must complete the second task, too.</strong>
  <br>
  <p>You can also feel free to leave any comments below about how the experiment went, but that's up to you. Did everything seem to work OK?</p>
	<textarea id="commentBox" rows=4 cols=40 placeholder="Enter your comments here..."></textarea>
	<input type="hidden" id="comments" name="comments">
  <br>
  <br>
  <br>
  <a href='javascript:submitData("./2d_data")' id='submitDataButton' class='button'>Submit results</a>
  <br>
  <span id="redirectToProlific">
    <p>Your browser should automatically redirect you to the webpage of the second task. After completing that, you will finish the study.</p>
    <p>Redirecting in <span id = countDown><b></b></span> seconds.</p>
    <p>If you're not automatically redirected in a few seconds, please copy and paste this address on your web browser:
    <b><span id = urlProlific></span></b></p>
  </span>
</div>

<script>
$(document).ready(introRoutines);

// hide all things aside from instructions
$('#trialInstructions').hide();
$('#redirectToProlific').hide();
$('#likertscale').hide();
$('#experiment').hide();

var requestAnimationFrame = window.requestAnimationFrame ||
                            window.mozRequestAnimationFrame ||
                            window.webkitRequestAnimationFrame ||
                            window.msRequestAnimationFrame;

// experiment params
var experimentName = 'randomness';
var experimentVersion = '2d_task';

// timing params
var itiTime = 750; // 750 ms between trials

// various global vars
var currentTrialNum;
var trial;
var subjectID, studyID, sessionID;
var responses = {};
var startHITTime;
var startExperimentTime;
var t0_respond;
var answeredSum = false;
var answeredTask = false;
var answeredPurpose = false;

// define nTrials
var nTrials = 250;

// get browser params, tell user browser is not compatible if needed
var browserInfo = getBrowser();
if (browserInfo['name'] == "msie" || browserInfo['name'] == "Opera") {
  $('#browserCompat').show();
} else {
  $('#browserCompat').hide();
}

// redirect params
var urlProlific = "number_to_end.html"; // redirect to next task
var finalCountDownClock = 5;

// when the document has loaded
function introRoutines() {
  [subjectID, studyID, sessionID] = getProlificInfo();

  currentTrialNum = -1;

  // gen trials
  trials = generateTrials();
  responses['trialData'] = [];

  startHITTime = currentTime();

}

function getProlificInfo() {
  let urlParams = new URLSearchParams(window.location.search);
  prolificPID = urlParams.get("PROLIFIC_PID");
  studyID = urlParams.get("STUDY_ID");
  sessionID = urlParams.get("SESSION_ID");
  urlProlific = "number_to_end.html?PROLIFIC_PID=" + prolificPID + "&STUDY_ID=" + studyID + "&SESSION_ID=" + sessionID;
  return [prolificPID, studyID, sessionID]
}


function generateTrials() {
  trials = [];
  for (i = 0; i < nTrials; i++) {
    var trial = {};
    trials.push(trial);
  }
  return trials;

}

function acceptedConsent() {
  $('#consent').hide();
  $('#experiment').show();
}

function StartExperiment() {
  $('#startExperiment').hide();
  $('#instructions').hide();
  $('#startInstructions').hide();
  startedExperiment = true;
  startExperimentTime = new Date();
  $('#progressContainer').show();
  $('.progress').show();
  $('#title').hide();
  loadTrial();

}

function loadTrial() {
  currentTrialNum++;
  if (currentTrialNum < nTrials) {
    trial = trials[currentTrialNum];
    trial['trialID'] = currentTrialNum;
    runTrial();
  } else {
    $('#likertscale').hide();
    showQuestion();
  }

}

function runTrial() {
  $('#progressBar').css('width',((currentTrialNum/nTrials)*100) + 'px');
  $('#trialInstructions').show();
  $("#likertscale :input").prop("disabled", false);
  $('#likertscale').show();

  t0_respond = currentTime();

  var isClicked = false;
  $("input[name='l']").change(function(){
    if (!isClicked) {
      isClicked = true;
      $("#likertscale :input").prop("disabled", true);
      trial['response'] = $('input[name=l]:checked').val();
      $('input[name=l]:checked + span').css("background-color", "teal");
      setTimeout(respond, itiTime);
    }
  });
}

function respond() {
  var rt = currentTime() - t0_respond;

  trial['rt'] = Math.round(rt * 10) / 10;
  trial['subjectID'] = subjectID;
  responses['trialData'].push(trial);
  $('input[name=l]:checked + span').css("background-color", "black");

  $("input[name='l']").each(function(){
    this.checked = false;
  });

  loadTrial();

}

function checkDemoAnswers() {
  if($('input[type=radio]:checked').length == 1) {
    answeredCatch = true;
  }

  if(answeredCatch == true && answeredSum == true && answeredTask == true && answeredPurpose == true) {
    $('#doneExperiment').show();
  }
}

function showQuestion() {
  $('#experiment').hide();
  $('#doneExperiment').hide();
  $('#questionText').show();

  document.getElementById('sumCheck').addEventListener('input', function() {
    var text = this.value;

    if (text == 2) {
        answeredSum = true;
    }

    if(answeredSum == true && answeredTask == true && answeredPurpose == true) {
      $('#doneExperiment').show();
    }
  });

  document.getElementById('purposeGuess').addEventListener('input', function() {
    var text = this.value;

    if (text.length >= 1) {
      answeredPurpose = true;
    }
    if(answeredSum == true && answeredTask == true && answeredPurpose == true) {
      $('#doneExperiment').show();
    }
  });

  document.getElementById('taskGuess').addEventListener('input', function() {
    var text = this.value;

    if (text.length >= 1) {
      answeredTask = true;
    }
    if(answeredSum == true && answeredTask == true && answeredPurpose == true) {
      $('#doneExperiment').show();
    }
  });

}

function doneExperiment() {
  $('#questionText').hide();
	$('#doneText').show();
  $('#submitButton').show();
	$("#submitButton").css('visibility','visible');
  $('.progress').hide();
	$('#commentBox').show();

  assignExperimentInfo();

}

function assignExperimentInfo() {
  responses['experimentName'] = experimentName;
  responses['experimentVersion'] = experimentVersion;
  responses['experimentTime'] = Math.round((currentTime() - startHITTime) * 10) / 10;

  responses['studyID'] = studyID;
  responses['sessionID'] = sessionID;

  responses['browserName'] = browserInfo['name'];
  responses['browserVersion'] = browserInfo['version'];
  responses['displayWindowHeight'] = $(window).height();
  responses['displayWindowWidth'] = $(window).width();
  responses['displayScreenHeight'] = screen.height;
  responses['displayScreenWidth'] = screen.width;

}

function submitData(outDir) {
  responses['purposeGuess'] = document.getElementById('purposeGuess').value;
  responses['taskGuess'] = document.getElementById('taskGuess').value;
  responses['commentText'] = document.getElementById('commentBox').value;
  responses['totalTime'] = Math.round((currentTime() - startHITTime) * 10) / 10;
  // get data string from response array
  var dataString = JSON.stringify(responses);

  // post response to server

  $.post("./logTrial.py", {
    subjectID: subjectID,
    dataString: dataString,
    outDir: outDir
  });


  $('#redirectToProlific').show();
  $('#urlProlific').text(urlProlific);
  $('#countDown').text((finalCountDownClock).toString());
  redirectTimer = setInterval(countDown, 1000);
}

function currentTime() {
  return performance.now();

}

// pads numbers with leading 0s for filenames
function pad(n) {
  n = n + '';
  return n.length >= 4 ? n : new Array(4 - n.length + 1).join(0) + n;

}

function getBrowser() {
  var ua=navigator.userAgent,tem,M=ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
  if(/trident/i.test(M[1])) {
    tem=/\brv[ :]+(\d+)/g.exec(ua) || [];
    return {name:'IE',version:(tem[1]||'')};
    }
  if(M[1]==='Chrome') {
    tem=ua.match(/\bOPR|Edge\/(\d+)/)
    if(tem!=null) {
      return {name:'Opera', version:tem[1]};
      }
    }
  M=M[2]? [M[1], M[2]]: [navigator.appName, navigator.appVersion, '-?'];
  if((tem=ua.match(/version\/(\d+)/i))!=null) {
    M.splice(1,1,tem[1]);
  }
  return {
    name: M[0],
    version: M[1]
  };

}

// randomly shuffle elements of array
function shuffle(array) {
  return array.sort(() => Math.random() - 0.5);

}

function countDown () {
  finalCountDownClock--;
  if (finalCountDownClock == 0) {
    clearInterval(redirectTimer);
    window.location = urlProlific;
  } else {
    $('#countDown').text((finalCountDownClock).toString());
  }
}

// get random integer
function getRandomInt(min, max) {
  min = Math.ceil(min);
  max = Math.floor(max);
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

// pad numbers
function pad(n, width=2) {
  n = n + '';
  return n.length >= width ? n : new Array(width - n.length + 1).join("0") + n;
}

//preloading
function preload(trialToLoad) {
  currImageName = trials[trialToLoad].image;
  var currImage = new Image();
  currImage.src = 'stimuli/' + currImageName + '.png';
  allImages.push(currImage);
  currImage.onload = function() {
  };
}

</script>

<style>
body {
  font-family: Helvetica,Arial;
  font-size: 14pt;
  height: 100%;
  margin: 10 auto;
  background-color: LightGrey;
}

#instructions,#startInstructions {
	display:block;
	max-width: 80%;
	margin: 0 auto;
	margin-top: 0px;
  text-align: left;
}

#trialInstructions {
	display:block;
	max-width: 80%;
	margin: 0 auto;
	margin-top: 0px;
  text-align: left;
  margin-bottom: -1.2em;
}

#title, #browserCompat {
  font-size: 18pt;
  text-align: center;
  margin: 0 auto;
}

input {
  position: relative;
  text-align: center;
  display: block;
  margin-left: auto;
  margin-right: auto;
}

#startExperiment, #consentButton, #purposeButton, #submitDataButton, #doneExperiment {
  width: 200px;
  color: black;
  text-align: center;
  border: 4px outset black;
  background: teal;
  padding: 5px;
  margin: 0 auto;
  display: flex;
  justify-content: center;
  text-decoration: none;
}

#startExperiment:hover, #consentButton:hover, #purposeButton:hover, #submitDataButton:hover, #doneExperiment:hover {
  color: white;
  text-decoration: none;
}

#startExperiment:active, #consentButton:active, #purposeButton:active, #submitDataButton:active, #doneExperiment:active {
	background: gray;
}

.progress {
  text-align: center;
  display: none;
  height: 15px;
}

#progressContainer {
  text-align: center;
  display: none;
}

#progressText {
  font-size: 14pt;
  color: black;
  font-weight: bold;
  margin-top: 10px;
  margin-bottom: 10px;
}

#progressOutline {
  display: inline-block;
  background: white;
  border: 3px solid black;
  width: 100px;
  margin: 5 auto;
  margin-bottom: 10px;
  border-radius: 5px;
}

#progressBar {
  background: #4CAF50;
  width: 0px;
  margin-bottom: 10px;
}

.container {
  margin: auto;
}

#doneText, #questionText {
	display:none;
	max-width: 500px;
	text-align:center;
	margin: 10 auto;
	padding-bottom:10px;
	font-size:14pt
}

#doneText p, #questiontext p {
	font-size:12pt
}

.doneTextStyle, .questionTextStyle{
  display: none;
}

#commentBox {
	display:none;
}

#submitButton {
	display:block;
  width: 100%;
  margin-top: 500px;
  margin-bottom: 50px;
}

.likert {
    --likert-rows: 3;
    display: inline-grid;
    width:40%;
    max-width:150px;
    height:40%;
    max-height:150px;
    grid-auto-rows: 3fr;
    gap: 0.25em;
    grid-template-columns: repeat(var(--likert-rows), minmax(0, 1fr));
    display:grid;
    margin-left: auto;
    margin-right: auto;
    margin-top: 10px;
}

.likert input {
    max-width: 150px;
    max-height: 150px;
    position: fixed;
    opacity: 0;
    pointer-events: none;
}

.likert span {
    border-radius: 5px;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    box-sizing: border-box;
    width: 40%;
    height: 40%;
    padding: 20px;
    background: #000000;
}

.likert input:checked + span {
    background: transparent;
}

.likert input:focus + span {
    outline: -webkit-focus-ring-color auto 1px;
}

</style>
